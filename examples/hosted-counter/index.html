<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Linera | Counter</title>
    <link href="style.css" rel="stylesheet">
    <link href="/icon.png" rel="icon">
  </head>
  <body>
    <div class="container">
      <div class="content">
        <div>
          <h2>Counter</h2>
          <p class="counter">Clicks: <span id="count">0</span></p>
          <button id="increment-btn">Click me!</button>
        </div>
      </div>

      <div class="log-panel">
        <h3>Chain history for <span id="chain-id" class="hash"></span></h3>
        <div class="log-container" id="log-container">
          <template id="block-template">
            <div class="log-entry">
              <span class="height"></span>: <span class="hash"></span>
            </div>
          </template>
        </div>
      </div>
    </div>

    <script type="module">
     import * as linera from '@linera/client';


      const COUNTER_APP_ID = '8f5b7fa0998d2dbf70fef95e1631b850f3f0d1660b9f6f0dac4d31da858a6e1644e74610a64238f911748d58beefb42022c2414285e1a7b76cb43a4b0f9a1daa00b7a85e90acb4badf7d04a239b2b6721bac885c3422cf3b93861695f1a5a33d9e010000000000000000000000';

            //'935fe86b872203233ab84463179eff98892902a14b36771397b0387a60bfb8f324ab97360f11e9d5073c2004bc4b800b4a28a974dc0fe0fab56e979728fdcf26b7a85e90acb4badf7d04a239b2b6721bac885c3422cf3b93861695f1a5a33d9e010000000000000000000000';

     //const COUNTER_APP_ID = location.search.replace(/^\?/, '') ||
     //    'dc5df03866d4580734adac3b191c05f0742b4d8c7218e482b6e3356e8de35f76a8ce776ded5e5bf9efaad108f37f7fd04ade44b0ba8373506379247d593f5ccbb7a85e90acb4badf7d04a239b2b6721bac885c3422cf3b93861695f1a5a33d9e010000000000000000000000';

     async function incrementCount(counter) {
         await counter.query('{ "query": "mutation { increment(value: 1) }" }');
     }

     async function updateCount(counter) {
         const response = await counter.query('{ "query": "query { value }" }');
         document.getElementById('count').innerText
             = JSON.parse(response).data.value;
     }

     document.addEventListener('DOMContentLoaded', async () => {
         await (await linera).default();

         const faucet = await new linera.Faucet('http://localhost:8081');
         const wallet = await faucet.createWallet();
         const client = await new linera.Client(wallet);
         const chain = await faucet.claimChain(client);

         document.getElementById('chain-id').innerText = chain;

         console.log('requesting application');
         const counter = await client.frontend().application(COUNTER_APP_ID);
         console.log('application retrieved');

         const logContainer = document.getElementById('log-container');
         const incrementBtn = document.getElementById('increment-btn');
         const blockTemplate = document.getElementById('block-template');

         updateCount(counter);
         client.onNotification(notification => {
             console.debug('received notification', notification);
             let newBlock = notification.reason.NewBlock;
             if (!newBlock) return;
             addLogEntry(newBlock);
             updateCount(counter);
         });

         function addLogEntry(block) {
             const entry = blockTemplate.content.cloneNode(true);
             entry.querySelectorAll('.height')[0].textContent = block.height;
             entry.querySelectorAll('.hash')[0].textContent = block.hash;
             logContainer.insertBefore(entry, logContainer.firstChild);
         }

         incrementBtn.addEventListener('click', () => {
             incrementCount(counter);
         });
     });
    </script>
  </body>
</html>
